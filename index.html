<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Prompt Generator - Shariah Check</title>
    
    <!-- START: Social Media Share / Logo Look -->
    <meta property="og:title" content="AI Image Prompt Generator - Powered by Gemini" />
    <meta property="og:description" content="Upload an image and generate a detailed prompt by analyzing its artistic features for the AI model." />
    <meta property="og:image" content="https://placehold.co/1200x630/06b6d4/ffffff?text=AI+PROMPT+GENERATOR" />
    <meta property="og:url" content="#" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="AI Image Prompt Generator" />
    <meta property="og:image" content="https://placehold.co/1200x630/06b6d4/ffffff?text=AI+PROMPT+GENERATOR" />
    <!-- END: Social Media Share / Logo Look -->

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            /* 2025 Modern Theme: Deep Space / Electric Cyan */
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0c; /* Deep Space Black */
            color: #f3f4f6; /* Light text for high contrast */
            background-image:
                radial-gradient(at 20% 25%, hsla(180, 80%, 25%, 0.3) 0px, transparent 50%),
                radial-gradient(at 80% 75%, hsla(210, 70%, 30%, 0.25) 0px, transparent 50%),
                radial-gradient(at 50% 50%, hsla(240, 60%, 15%, 0.2) 0px, transparent 50%);
        }
        .custom-loader {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top: 5px solid #06b6d4; /* Cyan-500 accent */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .drop-zone {
            border: 2px dashed #374151; /* Darker border */
            transition: background-color 0.2s, border-color 0.2s;
        }
        .drop-zone--over {
            background-color: rgba(6, 182, 212, 0.1); /* Cyan-500/10 hover */
            border-color: #06b6d4; /* Cyan-500 */
        }
        .drop-zone__input {
            display: none;
        }
        .gradient-text {
            /* Electric Cyan to Sky Blue Gradient */
            background: linear-gradient(to right, #00ffff, #06b6d4, #38bdf8); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        /* Custom scrollbar for result div */
        #result-wrapper::-webkit-scrollbar, .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #result-wrapper::-webkit-scrollbar-thumb, .modal-content::-webkit-scrollbar-thumb {
            background-color: #374151; /* bg-gray-700 */
            border-radius: 10px;
        }
        
        /* --- Styles for "Read More" overflow control --- */
        .result-collapsed-content {
            max-height: 160px; /* Reduced from 200px */
            overflow: hidden;
            position: relative;
            transition: max-height 0.5s ease-in-out; 
            /* Dark theme mask */
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }
        .result-text-full {
            transition: max-height 0.5s ease-in-out;
        }
        
        /* Dawah Specific Styling (Warm/Earthy/Green tone) */
        .dawah-box {
            background-color: #27302f; /* Dark forest green/black mix */
            border: 2px solid #10b981; /* Emerald-500 */
            color: #d1fae5; /* Light mint text */
        }

        /* Modal Styles */
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-container {
            transform: scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 90vw;
            max-height: 90vh;
        }
        .modal-open .modal-container {
            transform: scale(1);
        }
        .modal-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        .list-disc-custom {
            list-style-type: disc;
            margin-left: 1.5em;
        }

        /* Privacy Reminder Toast Style */
        #privacyReminderModal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Settings Icon (Top Right) -->
    <button id="settingsBtn" onclick="openModal('apiKeyModal')" class="absolute top-6 right-6 p-2 bg-gray-800/50 hover:bg-gray-700/70 text-cyan-400 rounded-full transition duration-300 transform hover:scale-110 ring-1 ring-gray-700 z-20">
        <!-- Settings Icon -->
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37.996.608 2.222.094 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
    </button>

    <main class="w-full max-w-6xl bg-black/40 backdrop-blur-xl rounded-2xl shadow-2xl ring-1 ring-white/10 p-6 md:p-8 relative">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold gradient-text">AI Image Prompt Generator</h1>
            <p class="text-gray-400 mt-2 max-w-2xl mx-auto">Upload an image and generate a detailed prompt by analyzing its artistic features for the AI model.</p>
            <!-- Security Message Box -->
            <p class="mt-4 text-center bg-lime-700/30 text-lime-300 py-2 px-4 rounded-lg max-w-xl mx-auto ring-1 ring-lime-600/50 text-sm font-medium">
                This is a client-side tool. Your image is sent to Google's AI server for processing. <a href="#" onclick="openModal('privacyPolicyModal'); return false;" class="underline font-bold text-lime-100 hover:text-white transition">Read the Privacy Policy.</a>
            </p>
        </header>
        
        <!-- Main Content: Upload and Result -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
            <!-- Left Panel: Image Upload -->
            <div class="flex flex-col items-center justify-center bg-black/30 rounded-xl p-4 ring-1 ring-gray-700 h-full shadow-lg hover:shadow-xl transition duration-300">
                <input type="file" id="fileInput" accept="image/*" class="drop-zone__input">
                <div id="dropZone" class="drop-zone w-full rounded-xl p-6 text-center cursor-pointer flex-grow flex flex-col justify-center">
                    <div id="upload-prompt-content">
                        <!-- Icon color adjusted to light gray -->
                        <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                        <p class="mt-2 text-gray-400 text-sm"><span class="font-semibold text-cyan-400">Click to Upload</span> or Drag and Drop</p>
                        <p class="text-xs text-gray-500 mt-1">(Max 10MB)</p>
                    </div>
                    <div id="preview-container" class="w-full hidden flex-grow flex items-center justify-center">
                        <img id="imagePreview" class="rounded-lg max-h-64 object-contain shadow-md ring-1 ring-cyan-500/50" alt="Image Preview"/>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Result -->
            <div class="bg-black/30 rounded-xl p-4 flex flex-col ring-1 ring-gray-700 shadow-lg hover:shadow-xl transition duration-300">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold text-white" id="resultTitle">Analysis Result</h2>
                    <!-- Copy Button adjusted for ONLY "Copy" text -->
                    <button id="copyButton" class="hidden items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold py-2 px-3 rounded-lg transition duration-300 disabled:opacity-50" onclick="copyToClipboard()" disabled>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        <span id="copyButtonText">Copy</span>
                    </button>
                </div>
                
                <!-- Result Wrapper -->
                <div id="result-wrapper" class="bg-gray-900/80 text-gray-300 rounded-md p-4 flex-grow overflow-y-auto min-h-[16rem] flex flex-col justify-center relative ring-1 ring-gray-800">
                    <div id="loader" class="custom-loader hidden self-center"></div>
                    <p id="placeholderText" class="text-gray-500 text-center">আপনার জেনারেট করা প্রম্পট এখানে দেখা যাবে... (Your generated prompt will appear here...)</p>
                    
                    <!-- Result Container with Collapse Logic -->
                    <div id="resultContainer" class="result-text-full">
                        <div id="resultContent" class="whitespace-pre-wrap text-sm text-gray-300">
                            <p id="resultText"></p>
                        </div>
                    </div>
                    
                    <!-- Read More/Less Button adjusted for cyan accent -->
                    <button id="readMoreBtn" onclick="toggleReadMore()" class="text-xs font-semibold mt-3 p-1 rounded transition duration-150 text-cyan-400 hover:text-cyan-300 hidden self-start">
                        <span id="readMoreText">Read More</span> <svg class="w-3 h-3 inline-block transform transition-transform duration-300" id="readMoreIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>

                    <p id="errorText" class="text-red-400 text-center hidden"></p>
                </div>
            </div>
        </div>

        <!-- Action Button Section & Creator Button -->
        <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
            <!-- Generate Button: Power Gradient (Electric Cyan/Sky) -->
            <button id="generateBtn" class="bg-gradient-to-r from-cyan-500 to-sky-500 hover:from-cyan-600 hover:to-sky-600 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105 shadow-xl shadow-cyan-500/30 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" disabled>
                Generate Prompt
            </button>
            
            <!-- Creator and Policy Buttons in a group -->
            <div class="flex gap-4">
                <button id="creatorBtn" onclick="openModal('creatorModal')" class="bg-gray-700/50 hover:bg-gray-600/70 text-gray-300 font-medium py-3 px-6 rounded-full text-md transition duration-300 transform hover:scale-[1.03] shadow-md ring-1 ring-gray-600">
                    Creator
                </button>
                <!-- New Privacy Policy Button -->
                <button id="policyBtn" onclick="openModal('privacyPolicyModal')" class="bg-gray-700/50 hover:bg-gray-600/70 text-gray-300 font-medium py-3 px-6 rounded-full text-md transition duration-300 transform hover:scale-[1.03] shadow-md ring-1 ring-gray-600">
                    Privacy Policy
                </button>
            </div>
        </div>
        
        <!-- New Section for Prompt Refinement/Halal Transformation -->
        <div id="refinementSection" class="mt-6 bg-black/30 rounded-xl p-5 ring-1 ring-gray-700 shadow-2xl hidden">
            <h2 class="text-xl font-bold text-cyan-400 mb-3 flex items-center gap-2" id="refinementTitle">
                ✨ Prompt Refinement
            </h2>
            <p class="text-gray-400 mb-3 text-sm" id="refinementDescription">
                Enter your instruction below to modify the generated prompt (e.g., "Change the style to a watercolor painting" or "Add a cyberpunk neon background").
            </p>
            
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="refinementInput" placeholder="Enter your desired modification here..." class="flex-grow bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-cyan-500 outline-none transition duration-200">
                <button id="refineBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-md transition duration-300 transform hover:scale-[1.02] disabled:opacity-50 disabled:transform-none" disabled>
                    ✨ Refine Prompt
                </button>
            </div>
        </div>


    </main>
    
    <!-- Floating History Button -->
    <button id="historyBtn" class="fixed bottom-6 right-6 bg-cyan-600 text-white rounded-full shadow-2xl transition duration-300 hover:bg-cyan-700 transform hover:scale-105 flex items-center justify-center gap-2 px-4 py-3 ring-4 ring-cyan-500/50 text-sm font-semibold">
        <!-- Clock Icon for History -->
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span>History</span>
    </button>

    <!-- Privacy Reminder Pop-up (Small, auto-closing modal) -->
    <div id="privacyReminderModal" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 p-3 bg-gray-800 rounded-lg shadow-xl ring-2 ring-cyan-500/50 text-sm text-center transition-opacity duration-300" style="width: auto; max-width: 90%;">
        <p class="font-medium text-white flex items-center gap-2 justify-center">
            <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-2-6h4m0 0V8m0 0v1m0 0V8a2 2 0 00-2-2H7a2 2 0 00-2 2v1m10 0v1m-2-1H7m12 10a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Your images are processed by Google servers for AI analysis.
        </p>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="modal-container bg-gray-900 rounded-2xl shadow-2xl relative flex flex-col w-full md:w-3/4 lg:w-1/2 ring-1 ring-gray-700">
            <!-- Modal Header -->
            <div class="p-5 border-b border-gray-700 sticky top-0 bg-gray-900 z-10 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Prompt History</h3>
                <button onclick="closeModal('historyModal')" class="text-gray-400 hover:text-white transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Modal Body (Scrollable Content) -->
            <div id="historyList" class="p-6 modal-content flex-grow space-y-4">
                <p id="emptyHistory" class="text-center text-gray-500">No prompts saved yet.</p>
                <!-- History Items will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Creator Modal -->
    <div id="creatorModal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="modal-container bg-gray-900 rounded-2xl shadow-2xl relative w-full max-w-sm md:max-w-md ring-1 ring-cyan-500/20">
            <!-- Modal Header -->
            <div class="p-5 border-b border-gray-700/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Creator Profile</h3>
                <button onclick="closeModal('creatorModal')" class="text-gray-400 hover:text-white transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Creator Card Content -->
            <div class="p-8 text-center">
                <!-- Profile Image -->
                <img src="https://placehold.co/128x128/06b6d4/ffffff?text=AS" alt="Creator Profile" class="w-32 h-32 rounded-full mx-auto object-cover border-4 border-cyan-500/70 shadow-xl"/>
                
                <h4 class="text-2xl font-bold text-white mt-4">Al Shakil</h4>
                <p class="text-md text-cyan-400 mb-4">Digital Enthusiast</p>

                <!-- Skills -->
                <div class="flex flex-wrap justify-center gap-2 mb-6">
                    <!-- Skills badges updated for dark theme/cyan colors -->
                    <span class="bg-cyan-900/50 text-cyan-200 text-xs font-medium px-3 py-1 rounded-full ring-1 ring-cyan-600">Affiliate Marketing</span>
                    <span class="bg-cyan-900/50 text-cyan-200 text-xs font-medium px-3 py-1 rounded-full ring-1 ring-cyan-600">Low-Level Prompt Engineer</span>
                </div>
                
                <!-- Contact Button -->
                <a href="https://www.facebook.com/al.shakil03" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-300 shadow-lg shadow-blue-500/30">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.99 3.65 9.13 8.44 9.8v-7H7.9v-2.8h2.54V9.61c0-2.52 1.49-3.91 3.77-3.91 1.09 0 2.05.19 2.32.28v2.7h-1.57c-1.24 0-1.48.59-1.48 1.46v1.94h2.95l-.48 2.8h-2.47v7C18.35 21.13 22 16.99 22 12z"/></svg>
                    <span>Contact on Facebook</span>
                </a>
            </div>
        </div>
    </div>

    <!-- API Key Setup Modal -->
    <div id="apiKeyModal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="modal-container bg-gray-900 rounded-2xl shadow-2xl relative flex flex-col w-full max-w-md ring-1 ring-cyan-500/20">
            <!-- Modal Header -->
            <div class="p-5 border-b border-gray-700 sticky top-0 bg-gray-900 z-10 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2v6a2 2 0 01-2 2h-6a2 2 0 01-2-2V9a2 2 0 012-2h6zM13 10V7h2V5H9v2h2v3m4 4v3h-4v2h4v-5z"></path></svg>
                    API Key Setup
                </h3>
                <button onclick="closeModal('apiKeyModal')" class="text-gray-400 hover:text-white transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Modal Body (API Key Input) -->
            <div class="p-6 modal-content space-y-4">
                <p class="text-sm text-gray-400">Your Gemini API Key is required for image analysis and prompt generation.</p>

                <div class="flex flex-col gap-3">
                    <input type="password" id="apiKeyInputModal" placeholder="Paste your Gemini API Key here (e.g., AIza...)" class="flex-grow bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-cyan-500 outline-none transition duration-200">
                    <button id="saveKeyBtnModal" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 px-6 rounded-lg transition duration-300 transform hover:scale-[1.02]">
                        Save/Update
                    </button>
                </div>
                <p id="keyStatusModal" class="mt-2 text-sm text-center font-medium"></p>

                <hr class="border-gray-700">

                <button id="toggleGuideBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    How to get your API Key
                </button>

                <!-- Guideline Section (Initially Hidden) -->
                <div id="guideContent" class="hidden bg-gray-800 p-4 rounded-lg space-y-3 ring-1 ring-cyan-500/10">
                    <p class="font-semibold text-white">Follow these steps to create your key:</p>
                    <ol class="list-decimal list-inside text-sm text-gray-300 space-y-2">
                        <li>Go to the <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline font-medium">Google AI Studio Get API Key page</a>.</li>
                        <li>Log in with your Google account.</li>
                        <li>Click the **"Create API Key"** button.</li>
                        <li>Copy the generated key.</li>
                        <li>Paste it into the input field above and click **"Save/Update"**.</li>
                        <li>You are ready to generate prompts!</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Privacy Policy Modal -->
    <div id="privacyPolicyModal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="modal-container bg-gray-900 rounded-2xl shadow-2xl relative flex flex-col w-full md:w-3/4 lg:w-1/2 ring-1 ring-gray-700">
            <!-- Modal Header -->
            <div class="p-5 border-b border-gray-700 sticky top-0 bg-gray-900 z-10 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Privacy Policy</h3>
                <button onclick="closeModal('privacyPolicyModal')" class="text-gray-400 hover:text-white transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Modal Body (Policy Content) -->
            <div class="p-6 modal-content flex-grow space-y-4 text-sm text-gray-300">
                <h4 class="text-lg font-bold text-cyan-400">1. Information Collection and Use</h4>
                <p>This application uses the Google Gemini API for image analysis and prompt generation. The image you upload is sent directly to Google's servers for processing. We **DO NOT** store these images on our own servers.</p>

                <h4 class="text-lg font-bold text-cyan-400">2. API Key</h4>
                <p>Your Gemini API Key is stored client-side in your browser's local storage. This key is used solely for communicating with the Google API and is never transmitted to us or any other third-party servers.</p>

                <h4 class="text-lg font-bold text-cyan-400">3. Prompt History</h4>
                <p>Generated prompts are temporarily saved in your browser's local storage to allow you easy access. You can clear this data at any time from the History section.</p>

                <h4 class="text-lg font-bold text-cyan-400">4. Cookies</h4>
                <p>This application only uses local storage to save user preferences (like the API key); no tracking cookies are utilized.</p>

                <p class="mt-6 font-medium text-center text-gray-400">By using this tool, you consent to our privacy policy.</p>
            </div>
        </div>
    </div>


    <script>
        // Constants and Globals
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/";
        const VISION_MODEL = 'gemini-2.5-flash-preview-05-20'; 
        const TEXT_MODEL = 'gemini-2.5-flash-preview-05-20';   
        const API_KEY_STORAGE_KEY = 'geminiApiKey';
        const DEFAULT_API_KEY = 'AIzaSyCOPiifSCFkBlq7AuWTtvfWvoNy5b8hMo0'; 
        
        // --- System Prompt for Image Analysis (UPDATED FOR IDENTITY PRESERVATION) ---
        const SYSTEM_PROMPT = `Analyze the provided image in extreme detail. The final output must be a single, cohesive, high-quality prompt suitable for advanced text-to-image models like the **nano banana model**.

**Instructions for the Output Prompt (Mandatory):**
1. **Identity & Realism (Crucial):** Maintain an objective, descriptive third-person tone. The prompt MUST describe the main subject's appearance, pose, and emotion with the **explicit goal of preserving the identity/likeness seen in the image**. Inject powerful realism modifiers like **Photorealistic, Ultra-detailed, High Fidelity** seamlessly throughout the prompt structure.
2. **Micro-details:** Describe every visible layer of clothing, pose, accessories, textures, colors, and environment details with absolute specificity, leaving nothing vague or general.
3. **Technical Specifications:** Explicitly specify the lighting setup (e.g., Volumetric lighting, rim light, subsurface scattering), composition (e.g., eye-level medium close-up, shallow depth of field), specific color palette, and camera specifics (e.g., CineStill 800T, 85mm lens, f/1.4, cinematic color grading).
4. **Output Format:** Synthesize all extracted details into one single, highly evocative, cohesive paragraph. End the prompt with this exact string: "A professional studio photograph, preserving subject's identity with 99%+ nano-level facial accuracy, authentic skin tones, hyper-detailed eyes, ultra-detailed, highly realistic, context-aware body realism with refined micro-details in light, shadow, and depth, masterpiece."`;

        // --- System Prompt for Prompt Refinement (Phase 4 - Normal Refinement) ---
        const REFINE_SYSTEM_PROMPT = `You are a world-class AI Prompt Engineer. Your task is to take a detailed, existing AI image generation prompt (the 'Original Prompt') and professionally modify it based on the user's short 'Refinement Instruction'.

Rules:
1. Preserve all technical details (like camera settings, lighting, technical terms) from the Original Prompt unless directly contradicted by the instruction.
2. Integrate the Refinement Instruction seamlessly and creatively into the Original Prompt to create a new, high-quality, single-paragraph prompt.
3. The final output must be ONE SINGLE PARAGRAPH. Do NOT use bullet points, numbered lists, or conversational text. Only output the new, refined prompt text.`;

        // --- System Prompt for Islamic Check (Phase 2) ---
        const ISLAMIC_CHECK_SYSTEM_PROMPT = `Act as an expert in Islamic Fiqh (jurisprudence) concerning visual representations and apparel. Analyze the provided image *strictly* for permissibility (Halal) or prohibition (Haram) based on widely accepted Sunnī Islamic standards.

Focus on the following criteria:
1.  **Awrah (Modesty):** For women, check if the image shows exposed hair, neck, chest, arms, or tight/revealing clothing (lack of Hijab/Jilbab). For men, check for clothing above the ankles or tight/revealing clothing of Awrah (navel to knees), or golden jewelry (if visible).
2.  **Prohibitions:** Check for visible tattoos, idols, polytheistic/Satanic symbols, or items associated with major sins (e.g., alcohol, explicit nudity).
3.  **Imagery:** Check for explicit depiction of animate beings (as some schools of thought prohibit making images of animate life) - treat this as a secondary, soft criteria unless the image is clearly an idol.

Your output MUST be a JSON object conforming to the provided schema. Do not output anything else.

JSON Schema:
{
  "verdict": "HALAL" | "HARAM",
  "reasons_bn": "A bulleted list of the specific reasons for the verdict in respectful, brief Bengali, where each point is separated by a newline character.",
  "quran_hadith_bn": "A very short, gentle, and relevant Quranic verse (with Surah:Ayat reference) or a well-known Hadith (with source like Bukhari/Muslim) citation in clear Bengali, relating to the reasons given."
}
`;

        // --- System Prompt for Halal Transformation (Phase 4 - Haram State) ---
        const HALAL_TRANSFORM_PROMPT = (originalPrompt, reasons) => `The original image (which led to the prompt: "${originalPrompt}") was deemed HARAM due to the following specific reasons: ${reasons}. 

The user now urgently requests a Halal-compliant AI image prompt.

Your task: Generate a completely new, detailed, single-paragraph AI image generation prompt (for Midjourney/Stable Diffusion) that **explicitly REMOVES** all prohibited elements and **ADDS elements of Islamic modesty and conformity**.

Specific instructions for transformation:
1.  **For Women:** If the image contained a woman, ensure she is wearing a **full Jilbab, Abaya, or modest full-coverage dress, and a Hijab or Niqab**.
2.  **For Men:** If the image contained a man, ensure he is wearing **modest attire** (e.g., Thawb/Jubba or loose-fitting, non-revealing clothing, and is clean of tattoos or forbidden symbols).
3.  **General:** Remove all other forbidden items (idols, alcohol, tattoos, etc.).
4.  **Output Format:** Output only the new, detailed, high-quality, single-paragraph Halal-compliant prompt.`;


        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewContainer = document.getElementById('preview-container');
        const uploadPromptContent = document.getElementById('upload-prompt-content');
        const generateBtn = document.getElementById('generateBtn');
        const loader = document.getElementById('loader');
        const resultText = document.getElementById('resultText');
        const placeholderText = document.getElementById('placeholderText');
        const errorText = document.getElementById('errorText');
        const copyButton = document.getElementById('copyButton');
        const copyButtonText = document.getElementById('copyButtonText');
        const readMoreBtn = document.getElementById('readMoreBtn');
        const resultContainer = document.getElementById('resultContainer');
        const readMoreText = document.getElementById('readMoreText');
        const readMoreIcon = document.getElementById('readMoreIcon');
        const historyBtn = document.getElementById('historyBtn');
        const historyList = document.getElementById('historyList');
        const emptyHistory = document.getElementById('emptyHistory');
        const resultTitle = document.getElementById('resultTitle');
        const privacyReminderModal = document.getElementById('privacyReminderModal');
        
        // Modal DOM Elements
        const apiKeyInputModal = document.getElementById('apiKeyInputModal');
        const saveKeyBtnModal = document.getElementById('saveKeyBtnModal');
        const keyStatusModal = document.getElementById('keyStatusModal');
        const toggleGuideBtn = document.getElementById('toggleGuideBtn');
        
        // New Refinement DOM Elements
        const refinementSection = document.getElementById('refinementSection');
        const refinementInput = document.getElementById('refinementInput');
        const refineBtn = document.getElementById('refineBtn');
        const refinementTitle = document.getElementById('refinementTitle');
        const refinementDescription = document.getElementById('refinementDescription');


        let uploadedFile = null;
        let isExpanded = false;
        const COLLAPSED_HEIGHT = 160; // Reduced height for collapsed view
        let currentApiKey = '';
        let currentGeneratedPrompt = ''; 
        let currentIslamicVerdict = 'NONE'; 
        let haramReasons = ''; 


        // --- API Key Management (Unchanged) ---
        function loadApiKey() {
            if (typeof __api_key !== 'undefined' && __api_key) {
                currentApiKey = __api_key;
                return true;
            }
            const storedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (storedKey) {
                currentApiKey = storedKey;
                return true;
            }
            currentApiKey = DEFAULT_API_KEY;
            return true; 
        }

        function updateKeyStatus() {
            loadApiKey(); 
            const hasUserSavedKey = localStorage.getItem(API_KEY_STORAGE_KEY) || (typeof __api_key !== 'undefined' && __api_key);
            
            if (hasUserSavedKey && currentApiKey !== DEFAULT_API_KEY) {
                const displayKey = currentApiKey.substring(0, 4) + '...' + currentApiKey.substring(currentApiKey.length - 4);
                keyStatusModal.textContent = `API Key loaded: ${displayKey}. Ready to generate prompt.`;
                keyStatusModal.className = 'mt-2 text-sm text-center text-emerald-400 font-medium';
                apiKeyInputModal.placeholder = 'Key saved. Paste new key to update.';
            } else {
                keyStatusModal.textContent = "Default Key is being used. Provide your personal key for higher rate limits.";
                keyStatusModal.className = 'mt-2 text-sm text-center text-yellow-400 font-medium';
                apiKeyInputModal.placeholder = 'Paste your personal key (AIza...) to change the default key.';
            }

            apiKeyInputModal.value = ''; 
            generateBtn.disabled = !uploadedFile; 
        }
        
        function saveKeyModal() {
            const key = apiKeyInputModal.value.trim();
            if (key.length > 20 && key.startsWith('AIza')) { 
                localStorage.setItem(API_KEY_STORAGE_KEY, key);
                updateKeyStatus();
                closeModal('apiKeyModal');
                showCustomToast('API Key successfully saved!');
            } else if (key.length > 0) {
                showErrorInModal('Invalid Key format. Ensure you pasted a correct Gemini API Key.');
            } else {
                localStorage.removeItem(API_KEY_STORAGE_KEY);
                updateKeyStatus();
                closeModal('apiKeyModal');
                showCustomToast('Default API Key restored.');
            }
        }
        
        function showErrorInModal(message) {
             const tempStatus = document.getElementById('keyStatusModal');
             tempStatus.textContent = message;
             tempStatus.className = 'mt-2 text-sm text-center text-red-400 font-medium';
        }
        
        function toggleGuide() {
            const guideContent = document.getElementById('guideContent');
            const isHidden = guideContent.classList.contains('hidden');
            
            if (isHidden) {
                guideContent.classList.remove('hidden');
                toggleGuideBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg> Hide Guide';
            } else {
                guideContent.classList.add('hidden');
                toggleGuideBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> How to get your API Key';
            }
        }

        // Custom Toast Notification (instead of alert)
        function showCustomToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #059669; color: white; padding: 10px 20px; border-radius: 8px; z-index: 1000; font-family: inherit; font-size: 14px; opacity: 0; transition: opacity 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.opacity = 1, 10);
            
            setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => toast.remove(), 1500);
            }, 1500);
        }

        // --- Privacy Reminder Pop-up (New Feature) ---
        function showPrivacyReminder() {
            const reminderModal = document.getElementById('privacyReminderModal');
            if (!reminderModal.classList.contains('hidden')) return; // Already visible or fading out

            reminderModal.classList.remove('hidden', 'opacity-0');
            reminderModal.classList.add('opacity-100');

            // Set timeout to start fading out
            setTimeout(() => {
                reminderModal.classList.remove('opacity-100');
                reminderModal.classList.add('opacity-0');
                
                // Set timeout to hide completely after fade out
                setTimeout(() => {
                    reminderModal.classList.add('hidden');
                    reminderModal.classList.remove('opacity-0');
                }, 300); // Duration of CSS transition
            }, 3000); // Display for 3 seconds
        }

        // --- Utility Functions ---
        window.openModal = function(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            if (modalId === 'apiKeyModal') { updateKeyStatus(); }
            setTimeout(() => {
                modal.querySelector('.modal-container').classList.add('modal-open');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            const modalContainer = modal.querySelector('.modal-container');
            if (modalContainer) {
                modalContainer.classList.remove('modal-open');
            }
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        function showError(message) {
            setLoadingState(false, 'generate');
            resultText.textContent = '';
            placeholderText.classList.add('hidden');
            errorText.textContent = message;
            errorText.classList.remove('hidden');
            copyButton.classList.add('hidden');
            copyButton.disabled = true;
            refinementSection.classList.add('hidden');
            resultTitle.textContent = 'Analysis Result';
            currentIslamicVerdict = 'NONE';
        }

        function clearResult() {
            currentGeneratedPrompt = '';
            haramReasons = '';
            resultText.textContent = '';
            errorText.textContent = '';
            errorText.classList.add('hidden');
            placeholderText.classList.remove('hidden');
            copyButton.classList.add('hidden');
            copyButton.disabled = true; 
            readMoreBtn.classList.add('hidden');
            resultContainer.classList.remove('result-collapsed-content');
            resultContainer.style.maxHeight = 'none';
            resultContainer.classList.remove('dawah-box'); 
            resultContainer.classList.add('bg-gray-900/80'); 
            isExpanded = false;
            refinementSection.classList.add('hidden'); 
            refinementInput.value = ''; 
            refineBtn.disabled = true;
            resultTitle.textContent = 'Analysis Result';
            currentIslamicVerdict = 'NONE';
        }

        // --- Read More Logic (Uses new COLLAPSED_HEIGHT) ---
        window.toggleReadMore = function() {
            isExpanded = !isExpanded;

            if (isExpanded) {
                resultContainer.classList.remove('result-collapsed-content');
                resultContainer.style.maxHeight = resultContainer.scrollHeight + "px";
                readMoreText.textContent = 'Read Less';
                readMoreIcon.style.transform = 'rotate(180deg)';
            } else {
                resultContainer.style.maxHeight = resultContainer.scrollHeight + "px";
                requestAnimationFrame(() => {
                    resultContainer.classList.add('result-collapsed-content');
                    resultContainer.style.maxHeight = COLLAPSED_HEIGHT + 'px'; 
                });
                
                readMoreText.textContent = 'Read More';
                readMoreIcon.style.transform = 'rotate(0deg)';
            }
        }
        
        function showResult(text, saveToCurrentPrompt = true, isRefined = false) {
            const cleanedText = text.trim();
            resultText.textContent = cleanedText;
            errorText.classList.add('hidden');
            placeholderText.classList.add('hidden');
            copyButton.disabled = false;
            copyButton.classList.remove('hidden');
            resultContainer.classList.remove('dawah-box'); 
            resultContainer.classList.add('bg-gray-900/80');
            resultTitle.textContent = isRefined ? 'Refined Prompt' : 'Generated Prompt';

            if (saveToCurrentPrompt) {
                currentGeneratedPrompt = cleanedText; 
                refinementSection.classList.remove('hidden'); 
                
                // Reset refinement section for normal flow
                refinementTitle.textContent = '✨ Prompt Refinement';
                refinementDescription.textContent = 'Enter your instruction below to modify the generated prompt (e.g., "Change the style to a watercolor painting" or "Add a cyberpunk neon background").';
                refineBtn.textContent = '✨ Refine Prompt';
                refineBtn.onclick = handleRefinePrompt; // Reset handler
                
                // Check if input is filled to enable refine button
                refineBtn.disabled = !refinementInput.value;
            }

            // Collapse logic
            isExpanded = false;
            resultContainer.classList.add('result-collapsed-content');
            resultContainer.style.maxHeight = COLLAPSED_HEIGHT + 'px'; 
            readMoreText.textContent = 'Read More';
            readMoreIcon.style.transform = 'rotate(0deg)';
            readMoreBtn.classList.add('hidden');

            setTimeout(() => {
                const contentHeight = document.getElementById('resultContent').offsetHeight; 

                if (contentHeight > COLLAPSED_HEIGHT + 5) { 
                    readMoreBtn.classList.remove('hidden');
                } else {
                    resultContainer.classList.remove('result-collapsed-content');
                    resultContainer.style.maxHeight = 'none';
                }
            }, 50); 
        }

        // --- Dawah/Haram Display Logic (Updated Feature) ---
        function displayHaramDawah(reasons, quranHadith, originalPrompt) {
            
            // Store details for potential transformation
            currentIslamicVerdict = 'HARAM';
            haramReasons = reasons;
            currentGeneratedPrompt = originalPrompt; 

            resultTitle.textContent = '⛔ Shariah Warning';
            placeholderText.classList.add('hidden');
            errorText.classList.add('hidden');
            copyButton.classList.add('hidden');
            
            // Apply Dawah styling
            resultContainer.classList.remove('result-collapsed-content');
            resultContainer.classList.remove('bg-gray-900/80');
            resultContainer.classList.add('dawah-box');
            resultContainer.style.maxHeight = 'none'; // Full height
            readMoreBtn.classList.add('hidden');
            
            // Format reasons into bullet points
            const reasonListHtml = reasons.split('\n').map(r => r.trim()).filter(r => r.length > 0).map(r => `<li class="mb-1">${r.startsWith('*') ? r.substring(1).trim() : r}</li>`).join('');

            const dawahMessage = `
                <h3 class="text-2xl font-bold text-red-300 mb-4 text-center">
                    আল্লাহ্ আমাদের সঠিক পথে পরিচালিত করুন। (May Allah guide us to the right path.)
                </h3>
                <p class="text-md font-medium mb-4 text-center text-red-100">
                    Your uploaded image contains elements contrary to Shariah. Therefore, AI prompt generation is not possible.
                </p>
                <div class="bg-gray-900/50 p-4 rounded-lg border-l-4 border-red-500 mb-6">
                    <p class="font-semibold text-red-300 mb-2">⛔ Reasons for Prohibition:</p>
                    <ul class="list-disc-custom text-sm text-gray-200">${reasonListHtml}</ul>
                </div>
                
                <p class="text-center font-semibold text-emerald-400 mb-2 mt-4 text-sm">
                    কোরআন ও হাদিসের দাওয়াহ: (Quran and Hadith Dawah)
                </p>
                
                <div class="bg-gray-800/70 p-4 rounded-lg text-center italic text-sm">
                    <p class="text-gray-300">
                        ${quranHadith}
                    </p>
                </div>
                <p class="mt-4 text-xs text-center text-gray-400">
                    (Please refrain from Haram. This is an AI-driven recommendation.)
                </p>
            `;

            resultText.innerHTML = dawahMessage;
            resultText.classList.remove('whitespace-pre-wrap');
            
            // Show Refinement section for transformation
            refinementSection.classList.remove('hidden');
            refinementTitle.textContent = '✅ Halal Transformation';
            refinementDescription.textContent = 'Click this button and the AI will automatically remove prohibited elements and generate a new Shariah-compliant prompt (e.g., changing attire to modest clothing).';
            refineBtn.textContent = 'Transform to Halal Prompt';
            refineBtn.disabled = false;
            refinementInput.value = "Change to modest attire and setting."; 
            refineBtn.onclick = handleHalalTransform; // Set new handler
        }


        // --- History Logic (Unchanged) ---
        function getHistory() {
            try {
                const history = localStorage.getItem('promptHistory');
                return history ? JSON.parse(history) : [];
            } catch (e) {
                console.error("Could not load history from localStorage:", e);
                return [];
            }
        }

        function saveHistory(prompt, imageUrl) {
            const history = getHistory();
            const newEntry = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                prompt: prompt,
                imageUrl: imageUrl 
            };
            history.unshift(newEntry);
            if (history.length > 20) {
                history.pop();
            }
            try {
                localStorage.setItem('promptHistory', JSON.stringify(history));
            } catch (e) {
                console.error("Could not save history to localStorage:", e);
            }
        }

        function renderHistoryModal() {
            const history = getHistory();
            historyList.innerHTML = ''; 

            if (history.length === 0) {
                emptyHistory.classList.remove('hidden');
                return;
            }

            emptyHistory.classList.add('hidden');

            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-gray-800/70 p-4 rounded-lg flex space-x-4 hover:bg-gray-800 transition duration-150 ring-1 ring-gray-700';
                
                historyItem.innerHTML = `
                    <img src="${item.imageUrl}" alt="Uploaded Image" class="w-16 h-16 object-cover rounded-md flex-shrink-0 ring-1 ring-cyan-500/50">
                    <div class="flex-grow">
                        <p class="text-xs text-gray-400 mb-1">${item.timestamp}</p>
                        <p class="text-sm text-gray-200 line-clamp-3">${item.prompt}</p>
                        <button class="mt-2 text-xs text-cyan-400 hover:text-cyan-300 font-medium" onclick="copyHistoryPrompt(${item.id})">Copy Prompt</button>
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        }
        
        window.copyHistoryPrompt = (id) => {
            const history = getHistory();
            const item = history.find(i => i.id === id);
            
            if (item) {
                const textarea = document.createElement('textarea');
                textarea.value = item.prompt;
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    closeModal('historyModal');
                    showCustomToast('Prompt successfully copied!');
                } catch (err) {
                    console.error('Copy failed using execCommand:', err);
                    showError('Copy failed: Please copy manually.'); 
                } finally {
                    document.body.removeChild(textarea);
                }
            }
        };


        // --- Phase 2: Islamic Permissibility Check ---
        async function performIslamicCheck(base64Image, mimeType) {
            const imageParts = {
                mimeType: mimeType,
                data: base64Image.split(',')[1] 
            };
            
            const payload = {
                contents: [{
                    parts: [
                        { text: "Analyze the image for Islamic permissibility." },
                        { inlineData: imageParts }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: ISLAMIC_CHECK_SYSTEM_PROMPT }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "verdict": { "type": "STRING", "enum": ["HALAL", "HARAM"] },
                            "reasons_bn": { "type": "STRING" },
                            "quran_hadith_bn": { "type": "STRING" }
                        },
                        "propertyOrdering": ["verdict", "reasons_bn", "quran_hadith_bn"]
                    }
                }
            };
            
            const apiUrl = `${API_URL}${VISION_MODEL}:generateContent?key=${currentApiKey}`;
            
            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `API Error during Islamic Check: ${response.status}`);
            }

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!jsonText) {
                throw new Error("Islamic check returned no readable structured data.");
            }
            
            return JSON.parse(jsonText);
        }

        // --- Phase 3: AI Prompt Generation (Halal path) ---
        async function generateAiPrompt(imageParts) {
            const payload = {
                contents: [{
                    parts: [
                        { text: "Generate the prompt based on the image's characteristics." },
                        { inlineData: imageParts }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                }
            };

            const apiUrl = `${API_URL}${VISION_MODEL}:generateContent?key=${currentApiKey}`;
            
            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `API Error during Prompt Generation: ${response.status}`);
            }

            const result = await response.json();
            const generatedText = result.candidates[0]?.content?.parts?.[0]?.text;

            if (!generatedText) {
                throw new Error("No readable text response received from the API.");
            }
            return generatedText;
        }


        // --- Main Handlers ---

        async function handleGenerate() {
            loadApiKey(); 

            if (!uploadedFile) {
                showError('Please upload an image first.');
                return;
            }

            showPrivacyReminder(); // Show reminder before generating

            setLoadingState(true, 'generate', 'Verifying permissibility according to Shariah...');
            clearResult(); 

            let base64Image;
            let initialPrompt;

            try {
                base64Image = await fileToBase64(uploadedFile);
                const imageParts = {
                    mimeType: uploadedFile.type,
                    data: base64Image.split(',')[1] 
                };
                
                // --- PHASE 3a: Get INITIAL prompt text (Needed for HARAM context) ---
                setLoadingState(true, 'generate', 'Analyzing image characteristics...');
                initialPrompt = await generateAiPrompt(imageParts);


                // --- PHASE 2: ISLAMIC CHECK (Runs on the image itself) ---
                setLoadingState(true, 'generate', 'Verifying image permissibility according to Islamic guidelines...');
                const islamicCheckResult = await performIslamicCheck(base64Image, uploadedFile.type);
                
                if (islamicCheckResult.verdict === "HARAM") {
                    setLoadingState(false, 'generate');
                    displayHaramDawah(islamicCheckResult.reasons_bn, islamicCheckResult.quran_hadith_bn, initialPrompt);
                    return; 
                }

                // --- PHASE 3b: PROMPT GENERATION (Only if HALAL is confirmed) ---
                setLoadingState(true, 'generate', 'Generating detailed prompt for the Shariah-compliant image...');
                
                // Success: Show result and save to history
                showResult(initialPrompt, true); 
                saveHistory(initialPrompt, base64Image); 
                currentIslamicVerdict = 'HALAL';
                
            } catch (error) {
                console.error('Error:', error);
                if (error.message.includes('API Key appears invalid') || error.message.includes('API key is invalid') || error.message.includes('API Error: 400')) {
                     showError(`API Key appears invalid or unauthorized. Please verify and update your key via the settings icon.`);
                } else {
                     showError(`A problem occurred while calling the API: (${error.message})`);
                }
            } finally {
                setLoadingState(false, 'generate');
            }
        }


        // --- Phase 4a: Halal Transformation Handler (New Feature) ---
        async function handleHalalTransform() {
            loadApiKey();

            if (currentIslamicVerdict !== 'HARAM' || !currentGeneratedPrompt || !haramReasons) {
                showError('Insufficient information for transformation. Please upload the image again.');
                return;
            }

            showPrivacyReminder(); // Show reminder before refinement

            setLoadingState(true, 'refine', 'Transforming to Halal prompt...');

            try {
                const userQuery = `Original Prompt based on HARAM image: "${currentGeneratedPrompt}"`;
                const systemPrompt = HALAL_TRANSFORM_PROMPT(currentGeneratedPrompt, haramReasons);
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const apiUrl = `${API_URL}${TEXT_MODEL}:generateContent?key=${currentApiKey}`;
                
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API Error: ${response.status}`);
                }

                const result = await response.json();
                const transformedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!transformedText) {
                    throw new Error("No readable text response received from the API.");
                }
                
                showResult(transformedText, true, true); // true for isRefined
                currentIslamicVerdict = 'HALAL';
                haramReasons = '';
                showCustomToast('Prompt successfully transformed to Halal-compliant!');
                
                refinementInput.value = '';
                refineBtn.disabled = true;
                refineBtn.onclick = handleRefinePrompt; 

            } catch (error) {
                console.error('Halal Transformation Error:', error);
                showError(`Halal transformation failed: (${error.message})`);
            } finally {
                setLoadingState(false, 'refine');
            }
        }


        // --- Phase 4b: Normal Refinement Handler ---
        async function handleRefinePrompt() {
            loadApiKey();
            const refinementInstruction = refinementInput.value.trim();

            if (!currentGeneratedPrompt || !refinementInstruction) {
                showError('Please generate a prompt first and provide a refinement instruction.');
                return;
            }

            showPrivacyReminder(); // Show reminder before refinement

            setLoadingState(true, 'refine', 'Refining prompt...');

            try {
                const userQuery = `Original Prompt: "${currentGeneratedPrompt}"\nRefinement Instruction: "${refinementInstruction}"`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: REFINE_SYSTEM_PROMPT }] }
                };

                const apiUrl = `${API_URL}${TEXT_MODEL}:generateContent?key=${currentApiKey}`;
                
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API Error: ${response.status}`);
                }

                const result = await response.json();
                const refinedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!refinedText) {
                    throw new Error("No readable text response received from the API.");
                }
                
                showResult(refinedText, true, true); 
                showCustomToast('Prompt successfully refined!');
                
                refinementInput.value = '';
                refineBtn.disabled = true;

            } catch (error) {
                console.error('Refinement Error:', error);
                showError(`Refinement failed: (${error.message})`);
                refinementSection.classList.remove('hidden'); 
            } finally {
                setLoadingState(false, 'refine');
            }
        }
        
        // --- API Utility with Backoff (Unchanged) ---
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { 
                        return response;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === retries - 1) throw error; 
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("API call failed after multiple retries.");
        }


        // --- Loading State and UI Update ---
        
        function setLoadingState(isLoading, actionType, statusMessage = '') {
            const isReady = !!uploadedFile; 
            
            generateBtn.disabled = isLoading;
            refineBtn.disabled = isLoading;

            if (isLoading) {
                loader.classList.remove('hidden');
                placeholderText.textContent = statusMessage; 
                placeholderText.classList.remove('hidden');
                resultText.textContent = '';
                errorText.classList.add('hidden');
                copyButton.classList.add('hidden');
                
                if (actionType === 'generate') {
                    generateBtn.textContent = 'Analyzing...';
                } else if (actionType === 'refine') {
                    refineBtn.textContent = 'Processing...'; 
                }

            } else {
                loader.classList.add('hidden');
                generateBtn.textContent = 'Generate Prompt';
                
                if (currentIslamicVerdict === 'HARAM') {
                    refineBtn.textContent = 'Transform to Halal Prompt';
                    refineBtn.onclick = handleHalalTransform;
                    refineBtn.disabled = false;
                } else if (currentIslamicVerdict === 'HALAL' && currentGeneratedPrompt) {
                    refineBtn.textContent = '✨ Refine Prompt';
                    refineBtn.onclick = handleRefinePrompt;
                    refineBtn.disabled = !refinementInput.value;
                } else {
                    refineBtn.textContent = '✨ Refine Prompt';
                    refineBtn.disabled = true;
                }

                copyButton.disabled = false;
            }
        }
        
        // --- Event Listeners and Initialization ---

        window.copyToClipboard = function() {
            if (resultText.textContent) {
                const textarea = document.createElement('textarea');
                textarea.value = resultText.textContent;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    copyButtonText.textContent = 'Copied!'; // Changed to Copied!
                    setTimeout(() => {
                        copyButtonText.textContent = 'Copy'; // Changed back to Copy
                    }, 2000);
                } catch (err) {
                    console.error('Copy failed:', err);
                    showError('Copy failed: Please copy manually.'); 
                }
                document.body.removeChild(textarea);
            }
        }

        function updateThumbnail(file) {
            uploadedFile = file;
            const reader = new FileReader();
            reader.onload = () => {
                imagePreview.src = reader.result;
                previewContainer.classList.remove('hidden');
                uploadPromptContent.classList.add('hidden');
                generateBtn.disabled = false; 
                clearResult();
                showPrivacyReminder(); // Show reminder after successful upload
            };
            reader.readAsDataURL(file);
        }
        
        function isValidFile(file) {
            const allowedTypes = ['image/png', 'image/jpeg', 'image/webp'];
            const maxSize = 10 * 1024 * 1024; // 10 MB
            if (!allowedTypes.includes(file.type)) {
                showError("Invalid file type. Please upload PNG, JPG, or WEBP.");
                return false;
            }
            if (file.size > maxSize) {
                showError("File size is too large. Maximum 10MB allowed.");
                return false;
            }
            return true;
        }


        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize API Key Check
            loadApiKey(); 
            copyButtonText.textContent = 'Copy'; // Ensure initial button text is 'Copy'

            // 2. API Key Listener (Modal buttons)
            saveKeyBtnModal.addEventListener('click', saveKeyModal);
            toggleGuideBtn.addEventListener('click', toggleGuide);
            
            // 3. Refinement Listeners 
            refineBtn.addEventListener('click', handleRefinePrompt);
            refinementInput.addEventListener('input', () => {
                if (currentIslamicVerdict === 'HALAL' || currentIslamicVerdict === 'NONE') {
                    refineBtn.disabled = !refinementInput.value.trim();
                } 
            });


            // 4. Drag and Drop listeners
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', e => {
                e.preventDefault();
                dropZone.classList.add('drop-zone--over');
            });
            ['dragleave', 'dragend'].forEach(type => {
                dropZone.addEventListener(type, () => dropZone.classList.remove('drop-zone--over'));
            });
            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                if (e.dataTransfer.files.length) {
                    const file = e.dataTransfer.files[0];
                    if (isValidFile(file)) {
                        fileInput.files = e.dataTransfer.files;
                        updateThumbnail(file);
                    }
                }
                dropZone.classList.remove('drop-zone--over');
            });

            // 5. File Input change
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (isValidFile(file)) {
                        updateThumbnail(file);
                    }
                }
            });
            
            // 6. Main Action Button
            generateBtn.addEventListener('click', handleGenerate);
            
            // 7. History Button
            historyBtn.addEventListener('click', () => {
                renderHistoryModal();
                openModal('historyModal');
            });
            
            // Set initial state of generate button based on file presence
            generateBtn.disabled = !uploadedFile; 
        });
    </script>
</body>
</html>
